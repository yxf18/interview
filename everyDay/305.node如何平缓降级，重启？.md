# Problem: node如何平缓降级，重启?

*[interview]: start
## 什么是平滑重启？
平滑重启不同于普通的重启，平滑重启可以做到在不影响用户的情况下重启服务，以便重新载入node程序，完成业务代码更新。

平滑重启一般应用于业务更新或者版本发布过程中，能够避免因为代码发布重启服务导致的暂时性服务不可用的影响。

## 平滑重启原理
node cluster分为主进程和子进程，主进程负责监控子进程，子进程负责接收客户端的连接和连接上发来的请求数据，做相应的处理并返回数据给客户端。当业务代码更新时，其实我们只要更新子进程，便可以达到更新代码的目的。
当WorkerMan主进程收到平滑重启信号时，主进程会向其中一个子进程发送安全退出(让对应进程处理完毕当前请求后才退出)信号，当这个进程退出后，主进程会重新创建一个新的子进程（这个子进程载入了新的node代码），然后主进程再次向另外一个旧的进程发送停止命令，这样一个进程一个进程的重启，直到所有旧的进程全部被置换为止。
1、worker进程轮流重启，间隔时间；
2、worker进程并不是直接重启，而是先关闭新请求监听，等当前请求都返回了，再重启。

可以尝试使用**pm2**启动node，可以平滑重启。

## 关键词: 平滑重启、关闭请求监听、创建新的子进程一个个替换旧进程
*[interview]: end
