# Problem: 实现单点登录的原理

*[interview]: start

## 什么是单点登录?
单点登录**SSO(single sign on)**是一个多系统共存的环境下，用户在一处登录后，就不用再其他系统中登录，也就是用户的一次登录得到其他所有系统的信任

比如现有业务系统A、B、C以及sso系统，第一次访问A系统时发现没有登录，引导用户到sso系统上登录，根据用户的登录信息，生成唯一的一个token凭证返回给用户。后期用户访问B、C系统的时候，携带上对应的凭证到sso系统去校验，校验通过后就可以单点登录

单点登录在大型网站中使用的频率比较高，例如，阿里旗下有天猫、淘宝、支付宝等网站，其背后的成百上千的子系统，用户操作一次或者交易可能涉及到很多子系统，每个子系统都需要验证，所以提出来用户登录一次就可以访问相互信任的应用系统

单点登录有一个独立的认证中心，只有认证中心才能接受用户的用户名和密码等信息的认证，其他系统不提供登录入口，只接受认证中心的间接授权。间接授权通过令牌实现，当用户提供的用户名和密码通过认证中心认证之后，认证中心会创建授权令牌，在接下来的跳转过程中，授权令牌作为参数发送给各个子系统，子系统拿到令牌即得到了授权，然后创建局部会话

## 单点登录原理
单点登录有同域和跨域两种场景:
### 同域
适用场景:都是企业自己的系统，所有系统都使用同一个一级域名通过不同的二级域名来区分

比如:企业有一个一级域名为zf.com，我们有三个系统分别是门户系统(sso.zf.com)，应用1(app1.zf.com)和应用2(app2.zf.com)，需要实现系统之间的单点登录，实现架构如下: 
核心原理
门户系统设置的**cookie的domain**为一级域名也是zf.com,这样就可以共享门户的cookie给所有的使用该域名xxx.zf.com的系统
2.使用session等技术让所有系统共享session
3.这样只要门户系统登录之后无论跳转应用1或是应用2，都能通过门户**cookie**中的sessionId读取到session中登录信息实现单点登录

### 跨域
单点登录之间的系统域名不一样，例如第三方系统。由于域名不一样不能共享cookie了，需要一个独立的授权系统，即一个独立的认证中心(passport)，子系统本身将不参与登录操作，当一个系统登录成功之后，passport将会颁发一个令牌给子系统，子系统可以拿着令牌去获取各自的资源，为了减少频繁认证，各个子系统在被passport授权之后，会建立一个局部会话，在一定时间内无法再次向passport发起认证

基本原理
a.用户访问a系统时，需要登录，用户未登录；
b.跳转到cas server,即sso系统，将登录状态写入SSO的session,浏览器（Browser)中写入SSO域下的cookie.
c.SSO系统登录完成后会生成一个ST(**Serviece Ticket**),然后跳转到a系统，同时将ST作为参数传递给app系统。
d.a系统拿到ST后，从后台向SSO发送请求，验证ST是否有效。
e.验证通过后，a系统将登录状态写入session并设置a域下的cookie

## 关键词: cookie的domain设置为顶级域名、ticket
*[interview]: end
